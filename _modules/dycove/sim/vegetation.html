

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dycove.sim.vegetation &mdash; DYCOVE 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DYCOVE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apiref/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DYCOVE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dycove.sim.vegetation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dycove.sim.vegetation</h1><div class="highlight"><pre>
<span></span><span class="c1">###############################################################</span>
<span class="c1">#  vegetation.py</span>
<span class="c1">###############################################################</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dycove.sim.vegetation_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">VegetationAttributes</span><span class="p">,</span> <span class="n">VegCohort</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dycove.utils.simulation_reporting</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reporter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dycove.utils.array_math</span><span class="w"> </span><span class="kn">import</span> <span class="n">cell_averaging</span><span class="p">,</span> <span class="n">sum_product</span><span class="p">,</span> <span class="n">sum_elementwise</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dycove.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIN_FRACTION</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Reporter</span><span class="p">()</span>


<span class="c1">##### ---------- Shared methods ---------- #####</span>
<div class="viewcode-block" id="SharedVegMethods">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.SharedVegMethods.html#dycove.sim.vegetation.SharedVegMethods">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SharedVegMethods</span><span class="p">:</span>

<div class="viewcode-block" id="SharedVegMethods.compute_veg_model_quantities">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.SharedVegMethods.html#dycove.sim.vegetation.SharedVegMethods.compute_veg_model_quantities">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_veg_model_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute weighted area averages of model vegetation variables.</span>

<span class="sd">        Handles the various fractions that are tracked within each grid cell.</span>

<span class="sd">        This function works the same no matter the number of species, and so it is shared </span>
<span class="sd">        by both classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For single species, self.cohorts is a list of VegCohort objects</span>
        <span class="c1"># For multiple species, self.cohorts is a flattened list of VegCohort objects for all species</span>
        <span class="n">cohorts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stemdensity</span>  <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stemdiameter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stemheight</span>   <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        
        <span class="c1"># Get list of cohort fractions and other attributes</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">]</span>
        <span class="n">densities</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">density</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">]</span>
        <span class="n">diameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">diameter</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">]</span>
        <span class="n">heights</span>   <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">height</span>   <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">]</span>        
        <span class="c1"># Stem density in a single cell: sum of n_i*frac_i over all fractions frac_i in cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stemdensity</span>  <span class="o">=</span> <span class="n">sum_product</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">densities</span><span class="p">)</span>
        <span class="c1"># For veg height/diameter we just need a weighted average value in each cell based on cell fractions.</span>
        <span class="c1"># Cells may have a sum of fractions less than 1, so we need to safely divide by the sum of fractions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stemdiameter</span> <span class="o">=</span> <span class="n">cell_averaging</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">diameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stemheight</span>   <span class="o">=</span> <span class="n">cell_averaging</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="VegetationSpecies">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VegetationSpecies</span><span class="p">(</span><span class="n">SharedVegMethods</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single vegetation species. Can (and will) handle multiple cohorts of the species.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_veg_filename : str or Path</span>
<span class="sd">        Path to JSON file containing vegetation attributes.</span>
<span class="sd">    mor : int</span>
<span class="sd">        1 if we want to consider morphology (burial/scour) for this vegetation unit, else 0</span>
<span class="sd">    rand_seed_frac : float</span>
<span class="sd">        Fraction of potentially colonized cells that will actually colonize, distributed randomly.</span>
<span class="sd">    rand_seed_method : str</span>
<span class="sd">        Options are &#39;random&#39; or &#39;deterministic&#39;. If rand_seed_frac is between 0 and 1, </span>
<span class="sd">        &#39;deterministic&#39; will use a seed to evaluate the SAME set of cells for each colonization, </span>
<span class="sd">        whereas &#39;random&#39; will be truly random each time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="VegetationSpecies.__init__">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">input_veg_filename</span><span class="p">,</span>
                 <span class="n">species_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">rand_seed_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">rand_seed_method</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
                 <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_vegetation_attributes</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">input_veg_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mor</span>         <span class="o">=</span> <span class="n">mor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_frac</span>   <span class="o">=</span> <span class="n">rand_seed_frac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_method</span> <span class="o">=</span> <span class="n">rand_seed_method</span>

        <span class="k">if</span> <span class="n">species_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">species_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">input_veg_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="c1"># Will become list of VegCohort objects, one for each cohort/colonization that occurs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VegCohort</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


    
<div class="viewcode-block" id="VegetationSpecies.load_vegetation_attributes">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.load_vegetation_attributes">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_vegetation_attributes</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VegetationAttributes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Parse vegetation input json file and store attributes in a dataclass. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">ls_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;life_stage_attr&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ls_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">ls_data</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">VegetationAttributes</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="VegetationSpecies.colonization">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.colonization">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">colonization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span> <span class="n">min_depths</span><span class="p">,</span> <span class="n">max_depths</span><span class="p">,</span> <span class="n">fl_dr</span><span class="p">,</span> <span class="n">combined_cohorts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Colonize a :class:`~dycove.sim.vegetation_data.VegCohort` by adding a new </span>
<span class="sd">        fraction to cells.</span>

<span class="sd">        This method only adds new fractions. Effective stem diameters and heights are </span>
<span class="sd">        computed elsewhere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ets : int</span>
<span class="sd">            Current ecological timestep within current ecological year.</span>
<span class="sd">        min_depths : numpy.ndarray</span>
<span class="sd">            Array of minimum water depths [m] at each cell over the previous period.</span>
<span class="sd">        max_depths : numpy.ndarray</span>
<span class="sd">            Array of maximum water depths [m] at each cell over the previous period.</span>
<span class="sd">        fl_dr : float</span>
<span class="sd">            Wet/dry threshold [m]; cells with depth above this value are considered wet.</span>
<span class="sd">        combined_cohorts : list of VegetationSpecies or None, optional</span>
<span class="sd">            Relevant only if multiple species are present. Provides information about</span>
<span class="sd">            other species occupying space in cells. See colonization method of </span>
<span class="sd">            :class:`~dycove.sim.vegetation.MultipleVegetationSpecies` for the use-case.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">start_col_ets</span> <span class="o">&lt;=</span> <span class="n">ets</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">end_col_ets</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doing colonization for species </span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, at ETS </span><span class="si">{</span><span class="n">ets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Get conditions for colonization</span>
            <span class="n">dry_cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_depths</span> <span class="o">&lt;</span>  <span class="n">fl_dr</span><span class="p">)</span>
            <span class="n">fld_cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_depths</span> <span class="o">&gt;=</span> <span class="n">fl_dr</span><span class="p">)</span>
            <span class="c1"># Get indices for potential colonization</span>
            <span class="n">potential_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dry_cond</span> <span class="o">&amp;</span> <span class="n">fld_cond</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Create mask for potential colonization based on input fraction and method</span>
            <span class="n">rand_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_seed_fraction_mask</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">min_depths</span><span class="p">))</span>
            <span class="c1"># Apply potential inds to mask</span>
            <span class="n">potential_inds_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rand_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">potential_inds_mask</span><span class="p">[</span><span class="n">potential_inds</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">selected_inds</span> <span class="o">=</span> <span class="n">potential_inds_mask</span> <span class="o">&amp;</span> <span class="n">rand_mask</span>

            <span class="n">existing_cohorts</span> <span class="o">=</span> <span class="n">combined_cohorts</span> <span class="k">if</span> <span class="n">combined_cohorts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span>
            <span class="n">new_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_new_fraction</span><span class="p">(</span><span class="n">existing_cohorts</span><span class="p">,</span> <span class="n">selected_inds</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_depths</span><span class="p">))</span>

            <span class="c1"># Create new cohort for latest colonization</span>
            <span class="c1"># new_veg_fraction is an array, other quantities are scalars</span>
            <span class="n">new_cohort</span> <span class="o">=</span> <span class="n">VegCohort</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">fraction</span><span class="o">=</span><span class="n">new_fraction</span><span class="p">,</span>
                <span class="n">density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemdens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">diameter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemdiam_0</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemht_0</span><span class="p">,</span>
                <span class="n">rootlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">rootlength_0</span><span class="p">,</span>
                <span class="n">lifestage</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">lifestage_year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cohort</span><span class="p">)</span></div>



<div class="viewcode-block" id="VegetationSpecies.create_seed_fraction_mask">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.create_seed_fraction_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_seed_fraction_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_len</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a mask based on random seeding &quot;&quot;&quot;</span>
        <span class="c1"># Number of indices where we will allow colonization</span>
        <span class="n">n_inds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed_frac</span><span class="o">*</span><span class="n">array_len</span><span class="p">))</span>
        <span class="c1"># Initialize mask with all False</span>
        <span class="n">rand_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_method</span> <span class="o">==</span> <span class="s2">&quot;deterministic&quot;</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>            
        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">array_len</span><span class="p">,</span> <span class="n">n_inds</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rand_mask</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">rand_mask</span></div>



<div class="viewcode-block" id="VegetationSpecies.compute_new_fraction">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.compute_new_fraction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_new_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">existing_cohorts</span><span class="p">,</span> <span class="n">inds2colonize</span><span class="p">,</span> <span class="n">array_len</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute a new cohortâ€™s fractional cover based on available space. &quot;&quot;&quot;</span>
        <span class="n">new_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_len</span><span class="p">)</span>
        <span class="n">existing_fractions</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_cohorts</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_fractions</span><span class="p">:</span>
            <span class="c1"># Create vegetation fraction array based on the hydro conditions and random filtering</span>
            <span class="n">new_fraction</span><span class="p">[</span><span class="n">inds2colonize</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Maybe find a better way of avoiding continuous appends with each colonization. </span>
            <span class="c1">#       E.g., avoid adding a new fraction if no space anywhere, etc. But that would mean </span>
            <span class="c1">#       that ZERO cells anywhere have favorable hydro conditions AND space available </span>
            <span class="c1">#       (not many cases).</span>
            <span class="c1"># Determine available space based on sum of fractions in each cell</span>
            <span class="n">fraction_uncovered</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sum_elementwise</span><span class="p">(</span><span class="n">existing_fractions</span><span class="p">)</span>
            <span class="c1"># Compute new fraction to be colonized; min: space available, max: initial veg fraction</span>
            <span class="n">candidate_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fraction_uncovered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="p">)</span>
            <span class="c1"># We apply new fractions where partial flooding condition is met, and within cells selected via seed_frac</span>
            <span class="n">new_fraction</span><span class="p">[</span><span class="n">inds2colonize</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_fraction</span><span class="p">[</span><span class="n">inds2colonize</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_fraction</span></div>



<div class="viewcode-block" id="VegetationSpecies.mortality">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.mortality">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mortality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hydro_vars</span><span class="p">,</span> <span class="n">morpho_vars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Delegate to internal methods. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mortality_hydrodynamic</span><span class="p">(</span><span class="o">**</span><span class="n">hydro_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mortality_morphodynamic</span><span class="p">(</span><span class="o">**</span><span class="n">morpho_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_mortality</span><span class="p">()</span></div>

        <span class="c1">#self.apply_mortality_using_initial_fractions()</span>

<div class="viewcode-block" id="VegetationSpecies.mortality_hydrodynamic">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.mortality_hydrodynamic">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mortality_hydrodynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fld_frac</span><span class="p">,</span> <span class="n">dry_frac</span><span class="p">,</span> <span class="n">vel_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute linear mortality functions for each hydrodynamic stressor (if activated).</span>

<span class="sd">        Hydrodynamic mortality is computed independently from vegetation characteristics</span>
<span class="sd">        like stem height, root length, etc. Mortality parameters can be dependent on life </span>
<span class="sd">        stage though, so we compute mortality for each life stage and apply to the </span>
<span class="sd">        fractions later (self.apply_mortality).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fld_frac : numpy.ndarray</span>
<span class="sd">            Array containing fractions of time that each cell was flooded during the </span>
<span class="sd">            previous period.</span>
<span class="sd">        dry_frac : numpy.ndarray</span>
<span class="sd">            Array containing fractions of time that each cell was dry during the </span>
<span class="sd">            previous period.</span>
<span class="sd">        vel_max : numpy.ndarray</span>
<span class="sd">            Array of maximum water velocities [m/s] at each cell over the previous period.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># These arrays of potential mortality get saved as cohort attributes, along with applied mortality below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_flood</span>  <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">nls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_desic</span>  <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">nls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_uproot</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">nls</span>
        <span class="c1"># Loop over life stages present in vegetation file, thresholds depend on lifestage</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">nls</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">flood_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if flood mortality is turned off, flag = 0 (TODO: create a better flag)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_flood</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fld_frac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_flood</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_mortality_func</span><span class="p">(</span><span class="n">fld_frac</span><span class="p">,</span> 
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">flood_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> 
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">flood_all_mort</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">desic_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if dessication is turned off, flag = 0 (TODO: create a better flag)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_desic</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dry_frac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_desic</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_mortality_func</span><span class="p">(</span><span class="n">dry_frac</span><span class="p">,</span> 
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">desic_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> 
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">desic_all_mort</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">uproot_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if uprooting is turned off, flag = 0 (TODO: create a better flag)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_uproot</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vel_max</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_uproot</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_mortality_func</span><span class="p">(</span><span class="n">vel_max</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">uproot_no_mort</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">uproot_all_mort</span><span class="p">[</span><span class="n">n</span><span class="p">])</span></div>

                

    <span class="c1"># TODO: Verify that we want the default scour_frac to be 10%, previous codes have just used 100% same as stem burial</span>
<div class="viewcode-block" id="VegetationSpecies.mortality_morphodynamic">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.mortality_morphodynamic">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mortality_morphodynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bl_diff</span><span class="p">,</span> <span class="n">burial_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scour_frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute linear mortality functions for each morphodynamic stressor (if activated).</span>

<span class="sd">        Morphodynamic stressors (burial, scour) are not currently functions of life stage,</span>
<span class="sd">        and they are binary (e.g., stem is either buried or not).</span>

<span class="sd">        Creates arrays of zeros if using a non-morphology model or with morphology turned </span>
<span class="sd">        off.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bl_diff : numpy.ndarray</span>
<span class="sd">            Array of cell-wise differences in bed level [m], from beginning to end of the </span>
<span class="sd">            previous period, where positive values signify burial.</span>
<span class="sd">        burial_frac : float</span>
<span class="sd">            Fraction of stem height above which vegetation is considered buried.</span>
<span class="sd">        scour_frac : float</span>
<span class="sd">            Fraction of root length above which vegetation is considered scoured.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If morphology is turned on (mor=1), but morphology is not active in the model (e.g., ANUGA)</span>
<span class="sd">          bl_diff will be passed as zero-difference arrays, and scour/burial will be set to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Loop over fractions and their current shoot/root lengths and compare to erosion/sedimentation</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
            <span class="c1"># If morphology is off, we still need these zero arrays for calculations in apply_mortality()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_burial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_scour</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_burial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bl_diff</span> <span class="o">&gt;=</span> <span class="n">burial_frac</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_scour</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bl_diff</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">scour_frac</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">rootlength</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="VegetationSpecies.apply_mortality">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.apply_mortality">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_mortality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiply potential mortality by vegetation fractions to determine actual mortality.</span>

<span class="sd">        Populate mortality-related fields of each active VegCohort object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: We track the fractions lost via each cause, but if all causes yield mortality fractions of 1,</span>
        <span class="c1">#       how should we track causes when, for instance, a cell only had a single fraction covering 40%?</span>
        <span class="c1">#       Is there an order of operations?</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
            <span class="c1"># Vegetation fractions lost to flooding</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_flood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_flood</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_flood</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_flood</span>
            <span class="c1"># Vegetation fractions lost to dessication</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_desic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_desic</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_desic</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_desic</span> 
            <span class="c1"># Vegetation fractions lost to uprooting</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_uproot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_uproot</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_uproot</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_uproot</span>
            <span class="c1"># Vegetation fractions lost to deposition</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_burial</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_burial</span>
            <span class="c1"># Vegetation fractions lost to erosion</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_scour</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_scour</span>
            <span class="c1"># Subtract all mortality fractions from actual fractions, but maintain minimum fraction of zero</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_total</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_flood</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_desic</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_uproot</span> <span class="o">+</span> \
                                   <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_burial</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_scour</span>
            <span class="n">fractions_left</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_total</span>
            <span class="n">fractions_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fractions_left</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># no negative fractions</span>

            <span class="c1"># Update fractions in cohort</span>
            <span class="c1"># For fractions that decay slowly over time, round down to zero when they get small enough</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fractions_left</span> <span class="o">&gt;</span> <span class="n">MIN_FRACTION</span><span class="p">,</span> <span class="n">fractions_left</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>



<div class="viewcode-block" id="VegetationSpecies.apply_mortality_using_initial_fractions">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.apply_mortality_using_initial_fractions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_mortality_using_initial_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Replacing `c.fraction` with `self.attrs.fraction_0`, so mortality is </span>
<span class="sd">        always a function of initial colonization fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
            <span class="c1"># Vegetation fractions lost to flooding</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_flood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_flood</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># For accounting purposes, no mortality if there is no fraction</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_flood</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_flood</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Vegetation fractions lost to dessication</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_desic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_desic</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_desic</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_desic</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Vegetation fractions lost to uprooting</span>
            <span class="n">c</span><span class="o">.</span><span class="n">potential_mort_uproot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_mort_uproot</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_uproot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_uproot</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Vegetation fractions lost to deposition</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_burial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_burial</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Vegetation fractions lost to erosion</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_scour</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">fraction_0</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">potential_mort_scour</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Subtract all mortality fractions from actual fractions, but maintain minimum fraction of zero</span>
            <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_total</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_flood</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_desic</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_uproot</span> <span class="o">+</span> \
                                    <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_burial</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_scour</span>
            <span class="n">fractions_left</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">applied_mort_total</span>
            <span class="n">fractions_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fractions_left</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># no negative fractions</span>

            <span class="c1"># Update fractions in cohort</span>
            <span class="c1"># For fractions that decay slowly over time, round down to zero when they get small enough</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fractions_left</span> <span class="o">&gt;</span> <span class="n">MIN_FRACTION</span><span class="p">,</span> <span class="n">fractions_left</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>



<div class="viewcode-block" id="VegetationSpecies.linear_mortality_func">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.linear_mortality_func">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">linear_mortality_func</span><span class="p">(</span><span class="n">stressor</span><span class="p">,</span> <span class="n">th_min</span><span class="p">,</span> <span class="n">th_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic, hydrodynamic stressor mortality function (linear).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stressor : numpy.ndarray</span>
<span class="sd">            Array of relevant stressor magnitude for each cell. For flooding/dessication,</span>
<span class="sd">            it is an array of fraction of time where cells are wet/dry. For uprooting, </span>
<span class="sd">            it is an array of maximum velocities.</span>
<span class="sd">        th_min : float</span>
<span class="sd">            Stressor value below which there is no mortality. Comes from JSON input file.</span>
<span class="sd">        th_max : float</span>
<span class="sd">            Stressor value above which there is total mortality. Comes from JSON input file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute fractional mortality based on linear interpolation</span>
        <span class="n">mort_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">stressor</span> <span class="o">-</span> <span class="n">th_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">th_max</span> <span class="o">-</span> <span class="n">th_min</span><span class="p">)</span>
        
        <span class="c1"># Updated, cleaner method to just bring all fractions outside the 0-1 range to 0 and 1</span>
        <span class="n">mort_frac</span><span class="p">[</span><span class="n">mort_frac</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mort_frac</span><span class="p">[</span><span class="n">mort_frac</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">mort_frac</span></div>



    <span class="c1"># TODO: Re-implement this, removed once the multi-species capability was added</span>
    <span class="c1"># The likelihood of this being called is fairly low</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_out_old_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If all fractions within a given cohort are zero, remove it from the list</span>
        <span class="n">cohorts_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fraction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="n">cohorts_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removed a cohort that has disappeared.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cohorts_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_old_cohorts</span><span class="p">(</span><span class="n">cohorts_to_remove</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">remove_old_cohorts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_inds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_of_inds</span><span class="p">]</span>

      
<div class="viewcode-block" id="VegetationSpecies.stemheight_growth">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.stemheight_growth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stemheight_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Computes stem height based on growth functions in VegAttributes. &quot;&quot;&quot;</span>
        <span class="c1"># During first growth ets, height starts at previous winter value, so no need to loop</span>
        <span class="k">if</span> <span class="n">ets</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">start_growth_ets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
                <span class="c1"># If none of these conditions are met, height stays the same</span>
                <span class="k">if</span> <span class="n">ets</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">end_growth_ets</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemht_max</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">height</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">ht_growth_rates</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">ets</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">winter_ets</span><span class="p">:</span>
                    <span class="c1"># Drop down to winter height, but by some chance if we are already below winter max, do nothing</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemht_winter_max</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="VegetationSpecies.stemdiam_growth">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.stemdiam_growth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stemdiam_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Computes stem diameter based on growth functions in VegAttributes. &quot;&quot;&quot;</span>
        <span class="c1"># During first growth ets, height starts at previous winter value, so no need to loop</span>
        <span class="k">if</span> <span class="n">ets</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">start_growth_ets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">diameter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemdiam_max</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ets</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">winter_ets</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">diameter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">diam_growth_rates</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># else, remains constant</span></div>



<div class="viewcode-block" id="VegetationSpecies.root_growth">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.root_growth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">root_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Computes root length based on growth functions in VegAttributes. &quot;&quot;&quot;</span>
        <span class="c1"># During first growth ETS, height starts at previous winter value, so no need to loop</span>
        <span class="k">if</span> <span class="n">ets</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">start_growth_ets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">rootlength</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">rootlength_max</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ets</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">winter_ets</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rootlength</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">root_growth_rates</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># else, remain constant</span></div>



<div class="viewcode-block" id="VegetationSpecies.update_lifestage_and_stemdensity">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.VegetationSpecies.html#dycove.sim.vegetation.VegetationSpecies.update_lifestage_and_stemdensity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_lifestage_and_stemdensity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Function to be called at the end of every eco year. </span>

<span class="sd">        Updates the life stage and the year within the life stage for each cohort.</span>

<span class="sd">        Stem density update is done here because it only depends on eco year and does not </span>
<span class="sd">        change during the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cohorts_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">):</span>
            <span class="c1"># If we have reached final year in the life stage</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lifestage_year</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">years_max</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># If unit has not yet reached final life stage</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lifestage</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">nls</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">lifestage</span>   <span class="o">+=</span> <span class="mi">1</span>    <span class="c1"># Move this fraction to next life stage</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">lifestage_year</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Restart counter for years within life stage</span>
                    <span class="c1"># TODO: Consider moving this elsewhere?</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">stemdens</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lifestage</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Apply stemdens from the NEXT lifestage (lifestage was just increased by 1)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># REMOVE FRACTION FROM LIST OF FRACTIONS, need to be careful with this</span>
                    <span class="n">cohorts_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">lifestage_year</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">cohorts_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_old_cohorts</span><span class="p">(</span><span class="n">cohorts_to_remove</span><span class="p">)</span></div>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return single drag coefficient for this species</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">drag</span></div>

    

<div class="viewcode-block" id="MultipleVegetationSpecies">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.MultipleVegetationSpecies.html#dycove.sim.vegetation.MultipleVegetationSpecies">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MultipleVegetationSpecies</span><span class="p">(</span><span class="n">SharedVegMethods</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for handling multiple vegetation species.</span>

<span class="sd">    We want to keep the hydrodynamics code clean, avoiding extra if statements regarding </span>
<span class="sd">    the number of species. This class handles the extra steps required, mostly containing </span>
<span class="sd">    wrappers of functions from VegetationSpecies that distribute the tasks to each species</span>
<span class="sd">    present.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    species_list : list[VegetationSpecies]</span>
<span class="sd">        A list of VegetationSpecies objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultipleVegetationSpecies.__init__">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.MultipleVegetationSpecies.html#dycove.sim.vegetation.MultipleVegetationSpecies.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VegetationSpecies</span><span class="p">]):</span>

        <span class="c1"># List of individual vegetation species objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_species_consistency</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cohorts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">VegCohort</span><span class="p">]:</span>
        <span class="c1"># Flatten vegetation cohorts across species into single list</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sp</span><span class="o">.</span><span class="n">cohorts</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">colonization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span> <span class="n">min_depths</span><span class="p">,</span> <span class="n">max_depths</span><span class="p">,</span> <span class="n">fl_dr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="c1"># Passing flattened list of all cohorts for all species for colonization calculation</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">colonization</span><span class="p">(</span><span class="n">ets</span><span class="p">,</span> <span class="n">min_depths</span><span class="p">,</span> <span class="n">max_depths</span><span class="p">,</span> <span class="n">fl_dr</span><span class="p">,</span> <span class="n">combined_cohorts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of veg fractions total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cohorts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stemheight_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">stemheight_growth</span><span class="p">(</span><span class="n">ets</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stemdiam_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">stemdiam_growth</span><span class="p">(</span><span class="n">ets</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">root_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">root_growth</span><span class="p">(</span><span class="n">ets</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mortality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hydro_vars</span><span class="p">,</span> <span class="n">morpho_vars</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">mortality</span><span class="p">(</span><span class="n">hydro_vars</span><span class="p">,</span> <span class="n">morpho_vars</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_lifestage_and_stemdensity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">update_lifestage_and_stemdensity</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_species_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Inherit the &quot;mor&quot; input parameter from the individual species object</span>
        <span class="c1"># We cannot have some species with mor=1 and others with mor=0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">mor</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All vegetation species inputs must have the same value for &#39;mor&#39;&quot;</span>
            <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mor</span>

<div class="viewcode-block" id="MultipleVegetationSpecies.get_drag">
<a class="viewcode-back" href="../../../_autosummary/dycove.sim.vegetation.MultipleVegetationSpecies.html#dycove.sim.vegetation.MultipleVegetationSpecies.get_drag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return average of drag coefficients for all species.</span>

<span class="sd">        Theoretically, we could take the weighted average of drag attributes based on species and </span>
<span class="sd">        lifestage, but DFM can only accept a single value. So for consistency we use a constant</span>
<span class="sd">        value throughout the simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">get_drag</span><span class="p">()</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">])</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, N. Tull, M. BrÃ¼ckner.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>